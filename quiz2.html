
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Quiz2 — Firebase (Auto-Reload + 4×1 + إصلاح لمس)</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--panel2:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--accent2:#06b6d4}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Tajawal,system-ui,Arial}
    .wrap{max-width:820px;margin:auto;padding:12px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .card{background:var(--panel);border:1px solid #233048;border-radius:14px;overflow:hidden}
    .q-head{padding:10px 12px;background:var(--panel2);border-bottom:1px solid #233048;display:flex;gap:10px;align-items:center}
    .badge{min-width:34px;height:34px;border-radius:999px;border:1px solid #2a364a;display:grid;place-items:center}
    .q-body{padding:10px;display:grid;gap:12px}
    .q-image{width:100%;max-height:40vh;object-fit:contain;background:#0a0f1a;border:1px dashed #334155;border-radius:10px}
    .options{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    @media(max-width:420px){.options{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .option{display:flex;gap:10px;align-items:center;justify-content:center;background:#0b1220;border:1px solid #233048;border-radius:10px;padding:10px;min-height:44px}
    canvas{width:100%;height:48vh;background:#09121b;border:1px solid #223049;border-radius:12px;touch-action:none}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#0b1220;border:1px solid #223049;color:#e5e7eb;padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#f87171,#ef4444);border:none;font-weight:700}
    .summary{display:none;background:#05201a;border:1px solid #124d3a;border-radius:12px;padding:12px;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Quiz2 — 4×1</h1>
    <div id="progress"></div>
  </header>
  <section id="stage" class="card"></section>
</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
import { getDatabase, ref as dRef, get, push, set } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
import { getStorage, ref as sRef, uploadString } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';
import { firebaseConfig } from './firebase-config.js';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app); const db = getDatabase(app); const storage = getStorage(app);
const stage = document.getElementById('stage'); const progressEl = document.getElementById('progress');

function showLoading(msg='جارٍ تحميل الأسئلة...'){
  progressEl.textContent='';
  stage.innerHTML = `
    <div class="q-head"><div class="badge">⏳</div><div>${msg}</div></div>
    <div class="q-body"><p class="muted">من فضلك انتظر لحظات…</p></div>`;
}
function showNoQuestions(){
  progressEl.textContent='';
  stage.innerHTML = `
    <div class="q-head"><div class="badge">!</div><div>لا توجد أسئلة لعرضها</div></div>
    <div class="q-body">
      <p class="muted">تأكد أنك رفعت الصور من <code>uploader.html</code>، وأن المسار <code>quizzes/quiz2/questions</code> يحتوي بيانات.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="./uploader.html" class="btn">فتح صفحة الرفع</a>
        <button id="retryBtn" class="btn primary">إعادة المحاولة</button>
      </div>
    </div>`;
  document.getElementById('retryBtn')?.addEventListener('click', ()=>{ autoRetryCount=0; autoLoad(); });
}
async function fetchQuestions(){
  const snap = await get(dRef(db,'quizzes/quiz2/questions'));
  let qs = snap.val() || [];
  if(!Array.isArray(qs)) qs = Object.values(qs);
  return qs;
}
let autoRetryCount = 0; const MAX_RETRIES=10; const RETRY_DELAY=3000;
async function autoLoad(){
  try{
    showLoading(autoRetryCount?`جارٍ التحميل… (محاولة ${autoRetryCount+1} من ${MAX_RETRIES})`:'جارٍ تحميل الأسئلة...');
    await signInAnonymously(auth);
    const questions = await fetchQuestions();
    if(questions.length){ startQuiz(questions); }
    else if(autoRetryCount < MAX_RETRIES-1){ autoRetryCount++; setTimeout(autoLoad, RETRY_DELAY); }
    else{ showNoQuestions(); }
  }catch(e){
    console.warn('خطأ أثناء الجلب', e);
    if(autoRetryCount < MAX_RETRIES-1){ autoRetryCount++; setTimeout(autoLoad, RETRY_DELAY); }
    else{ showNoQuestions(); }
  }
}
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ autoRetryCount=0; autoLoad(); } });
autoLoad();

function startQuiz(questions){
  let idx=0; const answers={};
  const render=()=>{
    const q=questions[idx];
    progressEl.textContent = `سؤال ${idx+1} من ${questions.length}`;
    stage.innerHTML = `
      <div class='q-head'><div class='badge'>${idx+1}</div><div>اختر ثم اكتب بالقلم</div></div>
      <div class='q-body'>
        <img class='q-image' src='${q.image}' alt='Q${idx+1}'/>
        <div class='options'>${['أ','ب','ج','د'].map(l=>`<label class='option'><input type='radio' name='q${q.id}' value='${l}' ${answers[q.id]===l?'checked':''}/> <b>${l}</b></label>`).join('')}</div>
        <div class='tools'>
          <button class='btn' data-act='pen'>قلم</button>
          <button class='btn' data-act='eraser'>ممحاة</button>
          <button class='btn' data-act='undo'>تراجع</button>
          <button class='btn danger' data-act='clear'>مسح اللوحة</button>
          <label>سُمك <input type='range' min='2' max='28' value='6' data-act='size'></label>
          <label>لون <input type='color' value='#22c55e' data-act='color'></label>
        </div>
        <canvas id='pad' width='1000' height='500'></canvas>
      </div>
      <div style='display:flex;justify-content:space-between;gap:10px;margin-top:10px'>
        <div>
          <button id='prev' class='btn'>السابق</button>
          <button id='next' class='btn'>التالي</button>
        </div>
        <div>
          <button id='submit' class='btn primary'>تسليم</button>
        </div>
      </div>
      <div id='summary' class='summary'></div>`;

    stage.addEventListener('change', e=>{ if(e.target.type==='radio'){ answers[q.id]=e.target.value; } });

    // Canvas with dpr fix
    const pad=document.getElementById('pad'); const ctx=pad.getContext('2d');
    let mode='pen', size=6, color='#22c55e', drawing=false, last=null, history=[]; const maxH=24;
    function fitCanvas(){ const rect=pad.getBoundingClientRect(); const dpr=Math.max(1,window.devicePixelRatio||1); let snap=null; try{ snap=pad.toDataURL('image/png'); }catch(e){} const w=Math.max(1,Math.floor(rect.width*dpr)); const h=Math.max(1,Math.floor(rect.height*dpr)); if(pad.width!==w||pad.height!==h){ pad.width=w; pad.height=h; } ctx.setTransform(dpr,0,0,dpr,0,0); if(snap){ const img=new Image(); img.onload=()=>{ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,pad.width,pad.height); ctx.drawImage(img,0,0,pad.width,pad.height); const dpr2=Math.max(1,window.devicePixelRatio||1); ctx.setTransform(dpr2,0,0,dpr2,0,0); }; img.src=snap; } }
    let t=null; const onR=()=>{ clearTimeout(t); t=setTimeout(fitCanvas,150); }; window.addEventListener('resize',onR); window.addEventListener('orientationchange',onR); fitCanvas();
    const getPos=e=>{ const r=pad.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top}; };
    const snapshot=()=>{ try{ history.push(pad.toDataURL('image/png')); if(history.length>maxH) history.shift(); }catch(e){} };
    pad.addEventListener('pointerdown', e=>{ drawing=true; last=getPos(e); pad.setPointerCapture(e.pointerId); });
    pad.addEventListener('pointermove', e=>{ if(!drawing) return; const p=getPos(e); const pressure=e.pressure&&e.pressure>0?e.pressure:1; const lw=(mode==='pen'?size:size*2)*(0.3+0.7*pressure); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=lw; ctx.globalCompositeOperation=(mode==='pen')?'source-over':'destination-out'; ctx.strokeStyle=color; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; });
    pad.addEventListener('pointerup', ()=>{ drawing=false; snapshot(); }); pad.addEventListener('pointercancel', ()=>{ drawing=false; });
    const tools=stage.querySelector('.tools');
    tools.addEventListener('click', e=>{ const a=e.target.dataset.act; if(a==='pen') mode='pen'; if(a==='eraser') mode='eraser'; if(a==='undo'){ const img=history.pop(); if(img){ const im=new Image(); im.onload=()=>{ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,pad.width,pad.height); ctx.drawImage(im,0,0,pad.width,pad.height); const dpr=Math.max(1,window.devicePixelRatio||1); ctx.setTransform(dpr,0,0,dpr,0,0); }; im.src=img; } } if(a==='clear'){ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,pad.width,pad.height); const dpr=Math.max(1,window.devicePixelRatio||1); ctx.setTransform(dpr,0,0,dpr,0,0); snapshot(); } });
    tools.querySelector('[data-act="size"]').addEventListener('input', e=> size=+e.target.value);
    tools.querySelector('[data-act="color"]').addEventListener('input', e=> color=e.target.value);

    document.getElementById('prev').onclick=()=>{ if(idx>0){ idx--; render(); } };
    document.getElementById('next').onclick=()=>{ if(idx<questions.length-1){ idx++; render(); } };

    document.getElementById('submit').onclick=async()=>{
      const dataUrl = pad.toDataURL('image/png');
      const ref = sRef(storage, `quiz2_submissions/${Date.now()}_lastpad.png`);
      await uploadString(ref, dataUrl, 'data_url');
      await set(push(dRef(db,'submissions/quiz2')), { at:new Date().toISOString(), answers });
      const s=document.getElementById('summary'); s.style.display='block'; s.textContent='تم التسليم.';
    };
  };
  render();
}
</script>
</body>
</html>
